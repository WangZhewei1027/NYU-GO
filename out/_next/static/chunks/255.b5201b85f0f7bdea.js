"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[255],{9636:(e,t,r)=>{r.r(t),r.d(t,{default:()=>z});var o=r(5155),n=r(833),l=r(5402),s=r(7288),a=r(3314),i=r(3710),c=r(8741),u=r.n(c),d=r(3306),m=r(2115);r(8413),r(9149),r(3919);var b=r(6176),h=r(9265),x=r(2364),p=r(6688),f=r(6756),g=r(2434);let j=e=>e<=11?0:e>=16?1:(e-11)/5,y=e=>{let{opacity:t=1}=e;return(0,o.jsx)("div",{className:"w-2 h-2 flex items-center justify-center rounded-full bg-white border-2 border-gray-500",style:{opacity:t}})},v=()=>{let e=(0,f.ko)(),[t,r]=(0,m.useState)(e.getZoom());(0,m.useEffect)(()=>{let t=()=>{r(e.getZoom())};return e.on("zoomend",t),()=>{e.off("zoomend",t)}},[e]);let n=j(t);function l(e){let{stopName:t}=e,r=p.P.getState().stopsData,n=null;for(let[e,o]of Object.entries(r))if((0,g.A)(e,t)){n=o.routes;break}return n?(0,o.jsx)("div",{children:n.map(e=>{var t;return(0,o.jsx)("span",{className:"inline mr-2 p-3 py-1 text-xs rounded-md text-gray-900 font-bold",style:{backgroundColor:null===(t=h._L[e])||void 0===t?void 0:t.color},children:e},e)})}):null}return(0,o.jsx)(o.Fragment,{children:Object.values(x.Gb).map(e=>(0,o.jsx)(i.p,{position:[e.latitude,e.longitude],icon:u().divIcon({className:"custom-stop",html:d.renderToString((0,o.jsx)(y,{opacity:n})),iconSize:[10,10],iconAnchor:[5,5]}),children:(0,o.jsxs)(a.z,{closeButton:!1,autoPan:!0,children:[(0,o.jsxs)("div",{className:"mb-2",children:[(0,o.jsxs)("span",{className:"font-bold text-base",children:[" ",e.name," "]}),(0,o.jsxs)("span",{children:["(",e.id,")"]})]}),(0,o.jsx)(l,{stopName:e.name})]})},e.id))})},N=JSON.parse('{"59666":"E","59829":"C","59830":"A","59831":"B","59832":"F","59833":"G","59834":"W"}'),S=e=>{if("Ferry Route"===e)return"ferry";if(/^Route\s[A-Z]$/.test(e)){let t=e.split(" ");if(t.length<2)return"?";let r=t[1].match(/[A-Z]/i);return r?r[0].toUpperCase():"?"}return"\uD83D\uDE8D"},k=e=>{var t,r;let{letter:n,heading:l=0}=e;return(0,o.jsxs)("div",{className:"relative w-8 h-8",style:{transform:"rotate(".concat(l,"deg)"),transformOrigin:"center center",transition:"transform 0.3s ease-in-out"},children:[(0,o.jsx)("div",{className:"absolute top-[-6px] left-1/2 w-0 h-0 border-l-[10px] border-r-[10px] border-b-[10px] border-transparent border-b-black",style:{transform:"translateX(-50%)",zIndex:-1}}),(0,o.jsx)("div",{className:"w-8 h-8 flex items-center justify-center rounded-full bg-white border-2 border-gray-800 text-black ".concat(null===(t=h._L[n])||void 0===t?void 0:t.borderColor," ").concat(null===(r=h._L[n])||void 0===r?void 0:r.textColor),style:{boxShadow:"0px 5px 10px rgba(0, 0, 0, 0.25)"},children:(0,o.jsx)("div",{style:{transform:"rotate(".concat(-l,"deg)")},children:"ferry"===n?(0,o.jsx)("img",{src:"/map/ferry.svg",alt:"ferry",className:"w-4 h-4"}):(0,o.jsx)("span",{className:"font-black",children:n})})})]})},w=()=>(0,o.jsx)("div",{className:"w-2 h-2 flex items-center justify-center rounded-full bg-blue-400 border-2 border-blue-600",style:{boxShadow:"0px 5px 10px rgba(0, 0, 0, 0.25)"}});function z(){let e=(0,b.A)(),t=(0,m.useMemo)(()=>({}),[]);return(0,o.jsxs)(n.W,{center:[40.73,-73.99],zoom:14,zoomAnimation:!0,zoomAnimationThreshold:1,maxZoom:18,minZoom:12,scrollWheelZoom:!0,style:{zIndex:0},className:"map-container",zoomControl:!1,children:[(0,o.jsx)(l.e,{url:"https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",updateWhenIdle:!1,updateWhenZooming:!1,keepBuffer:8}),(0,o.jsx)(v,{}),Object.entries(x.B4).map((e,t)=>{var r;let[n,l]=e,i=N[n],c=null===(r=h._L[i])||void 0===r?void 0:r.color;return l.map((e,t)=>{let r=e.map(e=>[Number(e.lat),Number(e.lng)]);return(0,o.jsx)(s.R,{positions:r,color:c||"#333",weight:c?4:2.5,opacity:c?.8:.4,dashArray:c?void 0:"5, 10",children:(0,o.jsxs)(a.z,{children:["路线 ",i,(0,o.jsx)("br",{}),"路线ID: ",n,(0,o.jsx)("br",{}),"颜色: ",c]})},"".concat(n,"-").concat(t))})}),Object.entries(e).map(e=>{let[r,n]=e;if(!n.latitude||!n.longitude||!n.route)return null;let l=S(n.route);return t[l]||(t[l]=u().divIcon({className:"custom-marker",html:d.renderToString((0,o.jsx)(k,{letter:l,heading:Number(n.calculatedCourse)})),iconSize:[30,30],iconAnchor:[15,15]})),(0,o.jsx)(i.p,{position:[Number(n.latitude),Number(n.longitude)],icon:t[l],zIndexOffset:1e3,children:(0,o.jsxs)(a.z,{children:["\uD83D\uDE8C ",n.route,(0,o.jsx)("br",{}),"# ",r,(0,o.jsx)("br",{}),"\uD83D\uDCCD ",Number(n.latitude),", ",Number(n.longitude)]})},r)}),(0,o.jsx)(i.p,{position:[p.P.getState().location.latitude,p.P.getState().location.longitude],icon:u().divIcon({className:"custom-user-location",html:d.renderToString((0,o.jsx)(w,{})),iconSize:[10,10],iconAnchor:[5,5]}),zIndexOffset:2e3,children:(0,o.jsxs)(a.z,{children:["\uD83D\uDCCD Your Location",(0,o.jsx)("br",{}),"Latitude: ",p.P.getState().location.latitude.toFixed(4),", Longitude: ",p.P.getState().location.longitude.toFixed(4)]})})]})}},6176:(e,t,r)=>{r.d(t,{A:()=>s});var o=r(2115);async function n(){let e={};for(let[t,r]of Object.entries((await fetch("https://nyu-go-backend-production.up.railway.app/shuttle-data").then(e=>e.json()).catch(e=>{throw console.error("❌ 请求失败:",e),Error("Failed to fetch shuttle data")})).buses)){let t=r[0].busId,o=r[0].route,n=r[0].latitude,l=r[0].longitude,s=r[0].calculatedCourse;e[t]={route:o,latitude:n,longitude:l,calculatedCourse:s}}return e}var l=r(6688);function s(){let[e,t]=(0,o.useState)({}),r=(0,l.P)();return(0,o.useEffect)(()=>{let e;return n().then(e=>{console.log("\uD83D\uDE8D 首次获取到的公交数据:",e),t(e)}).then(()=>{(e=new WebSocket("wss://nyu-go-backend-production.up.railway.app")).onopen=()=>{console.log("✅ WebSocket 连接已建立")},e.onmessage=e=>{try{let r=JSON.parse(e.data);t(e=>{if(!e[r.busId])return e;{let t=r.busId,o=r.latitude,n=r.longitude,l=e[t].route,s=e[t].calculatedCourse;return{...e,[t]:{route:l,latitude:o,longitude:n,calculatedCourse:s}}}})}catch(e){console.error("❌ 解析 WebSocket 数据出错:",e)}}}),()=>{if(e)try{e.close(),console.log("❌ WebSocket 连接已关闭")}catch(e){console.error("❌ WebSocket 关闭失败:",e)}}},[]),(0,o.useEffect)(()=>{r.setShuttleData(e)},[e]),e}}}]);